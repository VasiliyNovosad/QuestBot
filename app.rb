# /start http://lutsk.quest.ua/gameengines/encounter/play/57921
# .setlogin login
# .setpassword password
# /setchatcurrent
# /starttimer

# authorization: http://quest.ua/gameengines/encounter/play/58438?json=1
# get_info: http://quest.ua/login/signin?json=1 Content-Type: application/json body: {"Login": "login", "Password": "password"}
# send_code: http://quest.ua/gameengines/encounter/play/58438?json=1 Content-Type: application/json body: {"LevelId": level_id, "LevelNumber": level_number, "LevelAction.Answer": "code"}
# request: {"Level"=>{"LevelId"=>933556, "Name"=>"Логогрифы1", "Number"=>7, "Timeout"=>180, "TimeoutSecondsRemain"=>53, "TimeoutAward"=>-3, "IsPassed"=>false, "Dismissed"=>false, "StartTime"=>{"Value"=>63636752888060.01}, "HasAnswerBlockRule"=>false, "BlockDuration"=>0, "BlockTargetId"=>1, "AttemtsNumber"=>0, "AttemtsPeriod"=>0, "RequiredSectorsCount"=>3, "PassedSectorsCount"=>1, "SectorsLeftToClose"=>2, "Tasks"=>[{"ReplaceNlToBr"=>true, "TaskText"=>"<img src=\"http://d1.endata.cx/data/games/54310/logo1rg5fex56fe5xfe.png\">\r\n\r\nФО: слово слово", "TaskTextFormatted"=>"<img src=\"http://d1.endata.cx/data/games/54310/logo1rg5fex56fe5xfe.png\">\r<br/>\r<br/>ФО: слово слово"}], "MixedActions"=>[{"ActionId"=>156964385, "LevelId"=>933556, "LevelNumber"=>0, "UserId"=>1415039, "Kind"=>1, "Login"=>"Fr1end", "Answer"=>"штопор топор", "AnswForm"=>nil, "EnterDateTime"=>{"Value"=>63636753014587}, "LocDateTime"=>"27.07 14:50:14", "IsCorrect"=>true, "Award"=>nil, "LocAward"=>nil, "Penalty"=>0}], "Messages"=>[], "Sectors"=>[{"SectorId"=>1626074, "Order"=>1, "Name"=>"1", "Answer"=>nil, "IsAnswered"=>false}, {"SectorId"=>1626075, "Order"=>2, "Name"=>"2", "Answer"=>{"Answer"=>"штопор топор", "AnswerDateTime"=>{"Value"=>63636753014587}, "Login"=>"Fr1end", "UserId"=>1415039, "LocDateTime"=>nil}, "IsAnswered"=>true}, {"SectorId"=>1626077, "Order"=>3, "Name"=>"3", "Answer"=>nil, "IsAnswered"=>false}], "Helps"=>[], "PenaltyHelps"=>[], "Bonuses"=>[]}, "Levels"=>[{"LevelId"=>930811, "LevelNumber"=>1, "LevelName"=>"Ожидание игры", "Dismissed"=>false, "IsPassed"=>true, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>930815, "LevelNumber"=>2, "LevelName"=>"Стартовая заглушка", "Dismissed"=>false, "IsPassed"=>true, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933552, "LevelNumber"=>3, "LevelName"=>"Кубраи1", "Dismissed"=>false, "IsPassed"=>true, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933553, "LevelNumber"=>4, "LevelName"=>"Ребусы1", "Dismissed"=>false, "IsPassed"=>true, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933554, "LevelNumber"=>5, "LevelName"=>"Ассоциации1", "Dismissed"=>false, "IsPassed"=>true, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933555, "LevelNumber"=>6, "LevelName"=>"Метаграммы1", "Dismissed"=>false, "IsPassed"=>true, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933556, "LevelNumber"=>7, "LevelName"=>"Логогрифы1", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933557, "LevelNumber"=>8, "LevelName"=>"Анаграмматрицы1", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933558, "LevelNumber"=>9, "LevelName"=>"Словосочетания1", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933559, "LevelNumber"=>10, "LevelName"=>"Гибриды1", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933560, "LevelNumber"=>11, "LevelName"=>"Олимпийка1", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933561, "LevelNumber"=>12, "LevelName"=>"Кубраи2", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933562, "LevelNumber"=>13, "LevelName"=>"Ребусы2", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933563, "LevelNumber"=>14, "LevelName"=>"Ассоциации2", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933564, "LevelNumber"=>15, "LevelName"=>"Метаграммы2", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933565, "LevelNumber"=>16, "LevelName"=>"Логогрифы2", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933566, "LevelNumber"=>17, "LevelName"=>"Анаграмматрицы2", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933567, "LevelNumber"=>18, "LevelName"=>"Словосочетания2", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933568, "LevelNumber"=>19, "LevelName"=>"Гибриды2", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933569, "LevelNumber"=>20, "LevelName"=>"Олимпийка2", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933570, "LevelNumber"=>21, "LevelName"=>"Кубраи3", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933571, "LevelNumber"=>22, "LevelName"=>"Ребусы3", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933572, "LevelNumber"=>23, "LevelName"=>"Ассоциации3", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933573, "LevelNumber"=>24, "LevelName"=>"Метаграммы3", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933574, "LevelNumber"=>25, "LevelName"=>"Логогрифы3", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933575, "LevelNumber"=>26, "LevelName"=>"Анаграмматрицы3", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933576, "LevelNumber"=>27, "LevelName"=>"Словосочетания3", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933577, "LevelNumber"=>28, "LevelName"=>"Гибриды3", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933578, "LevelNumber"=>29, "LevelName"=>"Олимпийка3", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}, {"LevelId"=>933579, "LevelNumber"=>30, "LevelName"=>"Финишная заглушка", "Dismissed"=>false, "IsPassed"=>false, "Task"=>nil, "LevelAction"=>nil}], "GameId"=>54310, "GameTypeId"=>1, "GameZoneId"=>1, "GameNumber"=>368, "GameTitle"=>"Всё по три", "LevelSequence"=>0, "UserId"=>1415039, "TeamId"=>98139, "EngineAction"=>{"LevelNumber"=>7, "LevelAction"=>{"Answer"=>"штопор топор", "IsCorrectAnswer"=>true}, "BonusAction"=>{"Answer"=>nil, "IsCorrectAnswer"=>nil}, "PenaltyAction"=>{"PenaltyId"=>0, "ActionType"=>0}, "GameId"=>54310, "LevelId"=>933556}, "Event"=>0}


require 'telegram/bot'
require 'openssl'
require_relative 'lib/quest_parser'

OpenSSL::SSL::VERIFY_PEER = OpenSSL::SSL::VERIFY_NONE

token = '171556746:AAEd8YJrYhFsiLjVEkyIk2cmluEf2lWkA5s'
$parser = nil
$chat_id = nil # -24142491 # message.chat.id
$start_timer = false
$current_bot = nil
$timer_interval = 5

def run_bot(token)
  Telegram::Bot::Client.run(token) do |bot|
    $current_bot ||= bot
    bot.listen do |message|
      p "Message #{message.text} from #{message.from.first_name} #{message.from.last_name}"
      case message.text
        when '/start'
          bot.api.sendMessage(chat_id: $chat_id || message.chat.id, text: "Hello, #{message.from.first_name}")
        when '/stop'
          $parser = nil
          $chat_id = nil
        when /^\/start /
          $parser = QuestParser.new(message.text[7..-1].strip, 'link')
          # p $parser.url
        when '/restart'
          if $parser
            url = $parser.url
            login = $parser.login
            password = $parser.password
            $parser = nil
            $parser = QuestParser.new(url, 'link')
            $parser.login = login
            $parser.password = password
          end
        when '.help'
          bot.api.sendMessage(chat_id: $chat_id || message.chat.id,
                              text: "List of commands:
/start <game_link>
/stop
/restart
/starttimer
/starttimer <secs>
/stoptimer
/+
/*
/-
/. <answer1> <answer2> ... <answern>
/.<answer>  /,<answer>")
        when '/+', '/parse'
          send_updated_level(bot, $chat_id || message.chat.id) if $parser
        when '/++'
          send_updated_level(bot, message.chat.id) if $parser
        when '/-'
          send_needed_sectors(bot, $chat_id || message.chat.id) if $parser
        when '/--'
          send_needed_sectors(bot, message.chat.id) if $parser
        when '/*'
          send_full_level(bot, $chat_id || message.chat.id) if $parser
        when '/**'
          send_full_level(bot, message.chat.id) if $parser
        when /^\/(\.|,) /
          if $parser
            if $parser.get_html_from_url
              message.text[3..-1].strip.split(' ').each do |code|
                $parser.send_code(code)
              end
            else
              bot.api.sendMessage(chat_id: $chat_id || message.chat.id, text: $parser.errors.join("\n")) if $parser.errors.count > 0
              $parser.errors = []
            end
          end
        when /^\/(\.|,)/
          if $parser
            if $parser.get_html_from_url
              $parser.send_code(message.text[2..-1].strip)
            else
              bot.api.sendMessage(chat_id: $chat_id || message.chat.id, text: $parser.errors.join("\n")) if $parser.errors.count > 0
              $parser.errors = []
            end
          end
        when /^\.setlogin /
          $parser.login = message.text[10..-1].strip if $parser
        when /^\.setpassword /
          $parser.password = message.text[13..-1].strip if $parser
        when '/setchatcurrent'
          $chat_id = message.chat.id
        when /^\.setchat /
          $chat_id = message.text[9..-1].strip.to_i
        when '/stoptimer'
          $start_timer = false
        when '/starttimer'
          $timer_interval = 5
          $start_timer = true
        when /^\/starttimer /
          $timer_interval = message.text[12..-1].strip.to_i
          $start_timer = true
      end
    end
  end
end

def run_em
  loop do
    if $start_timer && $current_bot
      if $parser
        # p "-------Timer start---------#{Time.now}"
        if $parser.get_html_from_url
          $parser.parse_content(false)
          if $chat_id && $parser.question_texts_new.count > 0
            $parser.question_texts_new.each do |mess|
              $parser.question_texts.push(mess)
            end
            message_str = $parser.question_texts_new.join("\n")
            if message_str.length < 4000
              $current_bot.api.sendMessage(chat_id: $chat_id, text: message_str)
            else
              message_str.chars.each_slice(4000).map(&:join).each do |msg|
                $current_bot.api.sendMessage(chat_id: $chat_id, text: msg)
              end
            end
            $parser.question_texts_new = []
          end
        else
          # p $parser.errors
          $current_bot.api.sendMessage(chat_id: $chat_id, text: $parser.errors.join("\n")) if $chat_id && $parser.errors.count > 0
          $parser.errors = []
        end
        # p "-------Timer end---------#{Time.now}"
      end
    end
    sleep $timer_interval if $timer_interval
  end
end

def send_updated_level(bot, chat_id)
  if $parser.get_html_from_url
    $parser.parse_content(true)
    $parser.question_texts_new.each do |mess|
      $parser.question_texts.push(mess)
    end
    if $parser.question_texts_new.count > 0
      message_str = $parser.question_texts_new.join("\n")
      if message_str.length < 4000
        bot.api.sendMessage(chat_id: chat_id, text: message_str)
      else
        message_str.chars.each_slice(4000).map(&:join).each do |msg|
          bot.api.sendMessage(chat_id: chat_id, text: msg)
        end
      end
    end
    $parser.question_texts_new = []
  else
    bot.api.sendMessage(chat_id: chat_id, text: $parser.errors.join("\n")) if $parser.errors.count > 0
    $parser.errors = []
  end
end

def send_full_level(bot, chat_id)
  if $parser.get_html_from_url
    full_info = $parser.parse_full_info
    if full_info.count > 0
      message_str = full_info.join("\n")
      if message_str.length < 4000
        bot.api.sendMessage(chat_id: chat_id, text: message_str)
      else
        message_str.chars.each_slice(4000).map(&:join).each do |msg|
          bot.api.sendMessage(chat_id: chat_id, text: msg)
        end
      end
    end
  else
    bot.api.sendMessage(chat_id: chat_id, text: $parser.errors.join("\n")) if $parser.errors.count > 0
    $parser.errors = []
  end
end

def send_needed_sectors(bot, chat_id)
  if $parser.get_html_from_url
    needed_sectors = $parser.parse_needed_sectors
    bot.api.sendMessage(chat_id: chat_id, text: "Осталось закрити:\n#{needed_sectors.join(', ')}") if needed_sectors.count > 0
  else
    bot.api.sendMessage(chat_id: chat_id, text: $parser.errors.join("\n")) if $parser.errors.count > 0
    $parser.errors = []
  end
end

threads = []
threads << Thread.new { run_bot(token) }
threads << Thread.new { run_em }
threads.map(&:join)


